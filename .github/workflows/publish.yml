name: Release

on:
  push:
    tags: [ "v*.*.*", "v*.*.*-*" ]

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  verify:
    name: Verify metadata and run tests
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      tag_version: ${{ steps.meta.outputs.tag_version }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
      npm_dist_tag: ${{ steps.meta.outputs.npm_dist_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - run: npm ci

      - name: Validate tag format and compute metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-(rc|beta|alpha)\.[0-9]+)?$ ]]; then
            echo "Invalid tag format: $TAG"
            exit 1
          fi

          TAG_VERSION="${TAG#v}"
          echo "tag_version=$TAG_VERSION" >> "$GITHUB_OUTPUT"

          if [[ "$TAG_VERSION" =~ -(rc|beta|alpha)\. ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            if [[ "$TAG_VERSION" =~ -rc\. ]]; then
              echo "npm_dist_tag=next" >> "$GITHUB_OUTPUT"
            elif [[ "$TAG_VERSION" =~ -beta\. ]]; then
              echo "npm_dist_tag=beta" >> "$GITHUB_OUTPUT"
            else
              echo "npm_dist_tag=alpha" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "npm_dist_tag=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify all packages match tag version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${{ steps.meta.outputs.tag_version }}"
          ERRORS=0

          for pkg in packages/*/package.json; do
            PKG_NAME=$(node -p "require('./$pkg').name")
            PKG_VERSION=$(node -p "require('./$pkg').version")
            echo "$PKG_NAME: $PKG_VERSION (tag: $TAG_VERSION)"
            if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
              echo "::error::$PKG_NAME version ($PKG_VERSION) does not match tag ($TAG_VERSION)"
              ERRORS=$((ERRORS+1))
            fi
          done

          # Verify internal cross-deps are pinned to same version
          for pkg in packages/*/package.json; do
            PKG_NAME=$(node -p "require('./$pkg').name")
            node -e "
              const p = require('./$pkg');
              for (const depType of ['dependencies','devDependencies','peerDependencies']) {
                if (!p[depType]) continue;
                for (const [name, ver] of Object.entries(p[depType])) {
                  if (name.startsWith('@flyingrobots/bijou') && ver !== '$TAG_VERSION') {
                    console.log('::error::' + p.name + ' has ' + name + '@' + ver + ', expected $TAG_VERSION');
                    process.exitCode = 1;
                  }
                }
              }
            " || ERRORS=$((ERRORS+1))
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Version mismatch detected. Run: npm run version $TAG_VERSION"
            exit 1
          fi

      - name: Build
        run: npm run build

      - name: Type check
        run: npm run lint

      - name: Test
        run: npm test

      - name: Verify published files
        run: |
          (cd packages/bijou && npm pack --dry-run)
          (cd packages/bijou-node && npm pack --dry-run)
          (cd packages/bijou-tui && npm pack --dry-run)

  publish_npm:
    name: Publish npm (OIDC)
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: read
      id-token: write
    environment: npm
    strategy:
      matrix:
        package: [bijou, bijou-node, bijou-tui]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify.outputs.tag }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          registry-url: https://registry.npmjs.org

      - run: npm ci
      - run: npm run build

      - name: Upgrade npm CLI (>=11.5.1 for trusted publishing)
        run: npm i -g npm@latest

      - name: Publish @flyingrobots/${{ matrix.package }}
        uses: ./.github/actions/retry
        with:
          attempts: "3"
          delay_seconds: "15"
          command: cd packages/${{ matrix.package }} && npm publish --access public --tag "${{ needs.verify.outputs.npm_dist_tag }}" --provenance

  github_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [verify, publish_npm]
    if: ${{ always() && needs.verify.result == 'success' }}
    permissions:
      contents: write
    steps:
      - name: Build release summary
        shell: bash
        run: |
          cat > RELEASE_SUMMARY.md << 'EOF'
          ## Registry publish summary

          - npm: `${{ needs.publish_npm.result }}`

          Dist-tag: `${{ needs.verify.outputs.npm_dist_tag }}`
          Version: `${{ needs.verify.outputs.tag_version }}`

          If npm failed, re-run only that job from Actions.
          EOF

      - name: Create / update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.verify.outputs.tag }}
          prerelease: ${{ needs.verify.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          append_body: true
          body_path: RELEASE_SUMMARY.md

      - name: Fail if npm publish failed
        if: ${{ needs.publish_npm.result != 'success' }}
        run: |
          echo "npm publish failed."
          exit 1
